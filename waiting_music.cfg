# Call this macro to start the waiting music. You can either 
# pre-set the targets before calling this macro or supply 
# the target temperatures as arguments.
#
# For optimal use, split your starting gcode in two parts:
# [gcode_macro PRINT_START]
# gcode: 
#   # home, do some preperations
#   # Optionally set heater targers or pass them onto the following macro
#   START_WAITING_LOOP CALLBACK=PRINT_START_CONTINUE [EXTRUDER={target_extruder}] [BED={target_bed}] [CHAMBER={target_chamber}] 
#
# [gcode_macro PRINT_START_CONTINUE]
# gcode:
#   QUAD_GANTRY_LEVEL
#   BED_MESH_CALIBRATE ADAPTIVE=1
#   ...
# 
# The printer will appear paused during the waiting period. This is normal and 
# should be ignored
[gcode_macro START_WAITING_LOOP]
variable_tolerance: 0.3
variable_chamber_wait: 60  # %
gcode:
  SAVE_GCODE_STATE NAME=waiting_loop
  {% set callback = params.CALLBACK %}
  {% if callback %}
    SET_GCODE_VARIABLE MACRO=WAITING_ITERATION VARIABLE=callback VALUE='"{callback}"'
  {% endif %}
  {% set hotend = params.EXTRUDER|default(0)|int %}
  {% set bed = params.BED|default(0)|int %}
  {% set chamber = params.CHAMBER|default(0)|int %}

  {% if chamber > 0 %}
    SET_HEATER_TEMPERATURE HEATER=Chamber TARGET={chamber}
  {% endif %}
  
  {% if bed > 0 %}
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={bed}
  {% endif %}
  
  {% if hotend > 0 %}
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={hotend}
  {% endif %}

  PAUSE
  {action_respond_info("Printer looks to be paused. Print will continue once the printer heated up.")}
  UPDATE_DELAYED_GCODE ID=WAITING_LOOP DURATION=0.1

[delayed_gcode WAITING_LOOP]
gcode:
  WAITING_ITERATION

[gcode_macro WAITING_ITERATION]
variable_callback: ''
gcode:
  {% set vars = printer['gcode_macro START_WAITING_LOOP'] %}
  {% if "xyz" not in printer.toolhead.homed_axes %}
    G28
  {% endif %}
  MIDI_WAITING

  {% set wait_chamber = (printer['heater_generic Chamber'].target * vars.chamber_wait / 100) | round %}
  
  {% if printer.heater_bed.temperature|int < (printer.heater_bed.target|int - vars.tolerance) or
        printer.extruder.temperature|int < (printer.extruder.target|int - vars.tolerance) or
        printer['heater_generic Chamber'].temperature|int < (wait_chamber - vars.tolerance) %}
  
    M400
    UPDATE_DELAYED_GCODE ID=WAITING_LOOP DURATION=0.1
  
  {% else %}

    RESTORE_GCODE_STATE NAME=waiting_loop
    {callback}
    RESUME
  
  {% endif %}

[gcode_macro MIDI_WAITING]
gcode:
  # Place waiting music here. You can get it from https://midislicer.com/
  # 
  # For a seemless loop, you should remove the G4 command on line 4 and
  # try to see if you can make the end position close to the start
  # position. 
  G90
  G1 X147.40883 Y146.69873 F15000.00000
  G1 X145.89424 Y151.24248 F1755.03765
  G1 X141.40756 Y140.85166 F4255.62554
  G1 X155.94227 Y143.75072 F5655.40481
  G1 X151.39851 Y145.26531 F1755.03765
  G1 X147.23134 Y147.16134 F1676.26420
  G1 X144.33228 Y132.62663 F5655.40481
  G1 X150.18313 Y144.33825 F4958.95417
  G1 X134.66155 Y140.39220 F6142.87415
  G1 X143.83023 Y137.33597 F1755.03765
  G1 X139.35497 Y144.79473 F3236.12952
  G1 X143.89873 Y143.28014 F1755.03765
  G1 X148.06590 Y141.38411 F1676.26420
  G1 X143.21433 Y148.47175 F3194.09436
  G1 X147.38150 Y146.57572 F1676.26420
  G1 X142.52994 Y153.66336 F3194.09436
  G1 X144.22628 Y148.57432 F1969.96315
  G1 X155.38699 Y153.12796 F4546.08572
  G1 X139.19210 Y149.89776 F6347.97727
  G1 X144.28113 Y148.20141 F1969.96315
  G1 X148.94885 Y146.07763 F1881.54294
  G1 X141.02539 Y151.50132 F3585.24970
  G1 X157.07260 Y161.12965 F7264.86514
  G1 X162.49629 Y153.20619 F3585.24970
  G1 X151.08703 Y160.05175 F2424.35788
  G1 X156.64781 Y152.26364 F3572.69525
  G1 X151.01317 Y155.64442 F2424.35788
  G1 X153.82988 Y149.45377 F2511.55851
  G1 X145.49199 Y154.45650 F3632.43257
  G1 X148.30870 Y148.26585 F2511.55851
  G1 X153.31143 Y139.92796 F3632.43257
  G1 X151.79684 Y144.47172 F1755.03765
  G1 X141.40602 Y139.98503 F4255.62554
  G1 X144.30508 Y154.51974 F5655.40481
  G1 X145.81967 Y149.97599 F1755.03765
  G1 X147.71570 Y145.80882 F1676.26420
  G1 X150.61476 Y160.34353 F5655.40481
  G1 X144.76392 Y148.63191 F4958.95417
  G1 X160.28550 Y152.57796 F6142.87415
  G1 X151.11681 Y155.63419 F1755.03765
  G1 X155.59207 Y148.17543 F3236.12952
  G1 X151.04831 Y149.69002 F1755.03765
  G1 X146.88115 Y151.58605 F1676.26420
  G1 X151.73271 Y144.49841 F3194.09436
  G1 X147.56555 Y146.39444 F1676.26420
  G1 X142.71398 Y153.48208 F3194.09436
  G1 X144.41033 Y148.39304 F1969.96315
  G1 X155.57104 Y152.94668 F4546.08572
  G1 X139.37614 Y149.71648 F6347.97727
  G1 X144.46518 Y148.02014 F1969.96315
  G1 X149.13290 Y145.89636 F1881.54294
  G1 X141.20944 Y151.32005 F3585.24970
  G1 X157.25665 Y160.94837 F7264.86514
  G1 X162.68034 Y153.02491 F3585.24970
  G1 X151.27107 Y159.87047 F2424.35788
  G1 X156.83185 Y152.08236 F3572.69525
  G1 X151.19722 Y155.46315 F2424.35788
  G1 X154.01392 Y149.27249 F2511.55851
  G1 X145.67604 Y154.27523 F3632.43257
  G1 X148.49274 Y148.08457 F2511.55851
  G1 X153.49547 Y139.74668 F3632.43257
  G1 X151.24636 Y146.49402 F2629.58533
  G1 X136.02254 Y139.92049 F6376.23386
  G1 X157.14949 Y144.13443 F8473.53305
  G1 X150.40215 Y146.38354 F2629.58533
  G1 X144.21150 Y149.20025 F2511.55851
  G1 X165.33845 Y153.41418 F8473.53305
  G1 X148.24709 Y144.87574 F7430.03613
  G1 X153.96667 Y167.37337 F9203.91181
  G1 X159.63474 Y152.59939 F2890.07678
  G1 X147.63995 Y160.22438 F5409.37555
  G1 X150.43244 Y152.94570 F2890.07678
  G1 X153.79129 Y146.22230 F2783.11893
  G1 X142.33775 Y154.40023 F5352.99458
  G1 X145.69660 Y147.67683 F2783.11893
  G1 X157.15014 Y139.49890 F5352.99458
  G1 X150.82675 Y140.76015 F2377.80482
  G1 X158.71901 Y155.91033 F6583.12746
  G1 X140.69175 Y152.31466 F7125.36357
  G1 X147.01515 Y151.05340 F2377.80482
  G1 X148.91455 Y145.35521 F2211.20887
  G1 X139.59879 Y150.94467 F4077.26770
  G1 X152.05319 Y156.02614 F5102.80869
  G1 X157.64265 Y146.71038 F4077.26770
  G1 X148.44131 Y149.04964 F1723.78578
  G1 X151.00848 Y143.10426 F2388.38908
  G1 X146.44781 Y144.26372 F1723.78578
  G1 X146.13660 Y149.65748 F1984.36046
  G1 X147.85865 Y142.88391 F2582.76043
  G1 X147.54744 Y148.27767 F1984.36046
  G1 X149.26948 Y141.50411 F2582.76043

[gcode_macro MIDI_STARTUP]
gcode: 
  G90
  G1 X130.30799 Y135.84696 F15000.00000
  G4 P1000
  G1 X142.30975 Y152.65593 F8497.34923
  G1 X142.30975 Y152.65548 F0.16971
  G1 X140.18342 Y149.67747 F8497.34923
  G1 X140.18342 Y149.67736 F0.16971
  G1 X138.05710 Y146.69935 F8497.34923
  G1 X138.05710 Y146.69924 F0.16971
  G1 X89.84541 Y79.17673 F8497.34923
  G1 X89.84541 Y79.17684 F0.16971
  G1 X98.99986 Y91.99803 F9002.62790
  G1 X98.99986 Y91.99814 F0.16971
  G1 X107.70980 Y104.19679 F8497.34923
  G1 X107.70980 Y104.19691 F0.16971
  G1 X116.86425 Y117.01809 F9002.62790
  G1 X116.86425 Y117.01821 F0.16971
  G1 X125.57419 Y129.21686 F8497.34923
  G1 X125.57419 Y129.21697 F0.16971
  G1 X134.72864 Y142.03816 F9002.62790
  G1 X134.72864 Y142.03804 F0.16971
  G1 X122.72688 Y125.22907 F8497.34923
  G1 X122.72688 Y125.22952 F0.16971
  G1 X124.85320 Y128.20753 F8497.34923
  G1 X124.85320 Y128.20765 F0.16971
  G1 X126.97953 Y131.18565 F8497.34923
  G1 X126.97953 Y131.18577 F0.16971
  G1 X135.68948 Y143.38442 F8497.34923
  G1 X135.68948 Y143.38431 F0.16971
  G1 X126.97953 Y131.18565 F8497.34923
  G1 X126.97953 Y131.18577 F0.16971
  G1 X135.68948 Y143.38442 F8497.34923
  G1 X135.68948 Y143.38431 F0.16971
  G1 X126.97953 Y131.18565 F8497.34923
  G1 X126.97953 Y131.18577 F0.16971
  G1 X135.68948 Y143.38442 F8497.34923
  G1 X135.68948 Y143.38431 F0.16971
  G1 X126.97953 Y131.18565 F8497.34923
  G1 X126.97953 Y131.18577 F0.16971
  G1 X135.68948 Y143.38442 F8497.34923
  G1 X135.68948 Y143.38431 F0.16971
  G1 X128.04359 Y133.06838 F7125.39858
  G1 X128.04359 Y133.06849 F0.16971
  G1 X135.82128 Y144.18650 F7582.82269
  G1 X135.82128 Y144.18639 F0.16971
  G1 X123.81952 Y127.37742 F8497.34923
  G1 X123.81952 Y127.37787 F0.16971
  G1 X125.94585 Y130.35588 F8497.34923
  G1 X125.94585 Y130.35599 F0.16971
  G1 X128.07217 Y133.33400 F8497.34923
  G1 X128.07217 Y133.33411 F0.16971
  G1 X176.28386 Y200.85662 F8497.34923
  G1 X176.28386 Y200.85560 F0.16971
  G1 X178.22304 Y198.91609 F1398.49129
  G1 X178.22304 Y198.91597 F0.16971
  G1 X180.65372 Y196.48496 F1761.98861
  G1 X180.65372 Y196.48485 F0.16971
  G1 X183.53062 Y193.60762 F2095.36939
  G1 X183.53062 Y193.60751 F0.16971
  G1 X196.72606 Y180.41072 F2351.97262
  G1 X185.30046 Y172.95453 F7630.26380
  G1 X183.22235 Y172.10665 F4050.10194
  G1 X178.89586 Y176.43270 F2351.97262
  G1 X175.99024 Y174.53653 F7630.26380
  G1 X174.99012 Y175.53656 F2351.97262
  G1 X172.08450 Y173.64039 F7630.26380
  G1 X171.08437 Y174.64041 F2351.97262
  G1 X121.31887 Y142.16412 F7630.26380
  G1 X123.49060 Y139.99272 F1569.75340
  G1 X123.49072 Y139.99272 F0.16971
  G1 X126.06243 Y137.42133 F1866.76191
  G1 X126.06255 Y137.42133 F0.16971
  G1 X129.28025 Y134.20396 F2351.97262
  G1 X129.28025 Y134.20407 F0.16971
  G1 X113.61246 Y149.87321 F2796.98257
  G1 X124.39305 Y158.00083 F7540.18854
  G1 X123.33150 Y156.11111 F3877.73687
  G1 X128.45166 Y150.99051 F2796.98257
  G1 X126.37627 Y148.23769 F7540.18854
  G1 X127.54107 Y147.07279 F2796.98257
  G1 X125.46569 Y144.31996 F7540.18854
  G1 X126.63049 Y143.15506 F2796.98257
  G1 X91.26781 Y96.24953 F7540.18854
  G1 X89.09641 Y98.42126 F1569.75340
  G1 X89.09653 Y98.42126 F0.16971
  G1 X91.66824 Y95.84987 F1866.76191
  G1 X91.66824 Y95.84998 F0.16971
  G1 X88.62570 Y98.89286 F2219.96654
  G1 X88.62582 Y98.89286 F0.16971
  G1 X104.29495 Y83.22507 F2796.98257
  G1 X113.44976 Y94.99553 F8446.70404
  G1 X112.28496 Y96.16043 F2796.98257
  G1 X119.93085 Y106.47636 F7125.39858
  G1 X118.76605 Y107.64126 F2796.98257
  G1 X126.89367 Y118.42185 F7540.18854
  G1 X125.72887 Y119.58675 F2796.98257
  G1 X211.37430 Y220.82327 F8410.59513
